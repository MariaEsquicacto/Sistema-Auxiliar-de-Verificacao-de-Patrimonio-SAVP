<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/fotografia.css">
    <title>Fotografia</title>
</head>

<body>
    <header>
        <div class="menu">
            <button class="hamburguer">
                <div id="barra1" class="barra"></div>
                <div id="barra2" class="barra"></div>
                <div id="barra3" class="barra"></div>
            </button>
            <nav>
                <ul>
                    <div class="perfil" onclick="Perfil()">
                        <img src="../assets/man.png" alt="foto de perfil">
                        <div class="editar">
                            <p>Administrador</p><i class="bi bi-pencil" style="color: #fff; margin-left: 5px;"></i>
                        </div>
                    </div>
                    <div class="itensmenu">

                        <div class="cardmenu">
                            <i class="bi bi-house"></i>
                            <li><a href="home_admin.html">Home</a></li>
                        </div>
                        <div class="cardmenu">
                            <i class="bi bi-person-add"></i>
                            <li><a href="cadastro.html">Cadastrar Usuário</a></li>
                        </div>
                        <div class="cardmenu">
                            <i class="bi bi-house-add"></i>
                            <li><a href="cadastrar_ambientes.html">Cadastrar Ambientes</a></li>
                        </div>
                        <div class="cardmenu">
                            <i class="bi bi-house-door"></i>
                            <li><a href="ambientes.html">Ambientes</a></li>
                        </div>
                    </div>
                    <div class="sair" onclick="Sair()">
                        <i class="bi bi-box-arrow-right"></i>
                        <p>Sair</p>
                    </div>

                </ul>
            </nav>
        </div>
        <div class="logo">
            <img src="../assets/logo_senai.png" alt="logo-senai">
        </div>
        <div class="notificacao">
            <i class="bi bi-bell"></i>
        </div>
    </header>

    <main>
        <div class="escrita">
            <i class="bi bi-arrow-left" onclick="Voltar()"></i>
            <h1>Fotografia do Patrimônio</h1>
        </div>

        <div class="fotografia">
            <div class="cardf">
                <div class="foto"></div>
                <button type="submit">Capturar Foto</button>
            </div>
            <div class="cardf">
                <div class="foto"></div>
                <button type="submit">Capturar Foto</button>
            </div>
            <div class="finalizarbutton">
                <button type="submit" id="finalizar">Finalizar</button>
            </div>

        </div>


    </main>

    <!-- Modal de Sucesso -->
    <div id="modal-sucesso" class="modal-overlay">
        <div class="modal-content">
            <i class="bi bi-check-circle-fill" style="color: rgb(30, 175, 5); font-size: 80px;"></i>
            <h2>Verificação completa do Patrimônio!</h2>
            <p id="codigo-modal"></p>
        </div>
    </div>

    <script>
        const botoesCaptura = document.querySelectorAll(".cardf button");
        const btnFinalizar = document.getElementById("finalizar");
        let fotosCapturadas = 0;

        botoesCaptura.forEach(botao => {
            botao.addEventListener("click", async () => {
                const card = botao.parentElement;
                const fotoDiv = card.querySelector(".foto");

                if (!fotoDiv.classList.contains("capturada")) {
                    try {
                        // Pede acesso à câmera
                        const stream = await navigator.mediaDevices.getUserMedia({ video: true });

                        // Cria um elemento de vídeo temporário
                        const video = document.createElement("video");
                        video.srcObject = stream;
                        video.play();

                        // Espera até o vídeo carregar os dados
                        await new Promise(resolve => { video.onloadedmetadata = () => resolve(); });

                        // Captura a imagem via canvas
                        const canvas = document.createElement("canvas");
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext("2d");
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                        // Para a câmera
                        stream.getTracks().forEach(track => track.stop());

                        // Mostra a imagem no container
                        const imgURL = canvas.toDataURL("image/png");
                        fotoDiv.innerHTML = `<img src="${imgURL}" style="width:100%; height:100%; object-fit:cover;">`;
                        fotoDiv.classList.add("capturada");

                        fotosCapturadas++;

                        // Se todas as fotos foram capturadas, mostra o botão Finalizar
                        if (fotosCapturadas === botoesCaptura.length) {
                            btnFinalizar.style.display = "block";
                        }

                    } catch (err) {
                        console.error("Erro ao acessar a câmera: ", err);
                        alert("Não foi possível acessar a câmera.");
                    }
                }
            });
        });

        // Modal de sucesso e redirecionamento
        const modal = document.getElementById("modal-sucesso");

        btnFinalizar.addEventListener("click", () => {
            modal.style.display = "flex";

            setTimeout(() => {
                modal.style.display = "none";
                // Redireciona para a próxima página (alterar se necessário)
                window.location.href = "status.html";
            }, 2000);
        });

         // MENU
        const hamburguer = document.querySelector(".hamburguer");
        const nav = document.querySelector("nav");

        hamburguer.addEventListener("click", () => {
            // animação do hambúrguer (vira X)
            hamburguer.classList.toggle("aberto");

            // abre/fecha o menu
            nav.classList.toggle("ativo");
        });

    </script>
</body>

</html>