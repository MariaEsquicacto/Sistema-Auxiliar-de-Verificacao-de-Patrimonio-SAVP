<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/scanner.css">
    <title>Escannear Patrimônio</title>
</head>

<body>
    <header>
        <div class="menu">
            <button class="hamburguer">
                <div id="barra1" class="barra"></div>
                <div id="barra2" class="barra"></div>
                <div id="barra3" class="barra"></div>
            </button>
            <nav>
                <ul>
                    <div class="perfil" onclick="Perfil()">
                        <img src="../assets/man.png" alt="foto de perfil">
                        <div class="editar">
                            <p>Administrador</p><i class="bi bi-pencil" style="color: #fff; margin-left: 5px;"></i>
                        </div>
                    </div>
                    <div class="itensmenu">

                        <div class="cardmenu">
                            <i class="bi bi-house"></i>
                            <li><a href="home_admin.html">Home</a></li>
                        </div>
                        <div class="cardmenu">
                            <i class="bi bi-person-add"></i>
                            <li><a href="cadastro.html">Cadastrar Usuário</a></li>
                        </div>
                        <div class="cardmenu">
                            <i class="bi bi-house-add"></i>
                            <li><a href="cadastrar_ambientes.html">Cadastrar Ambientes</a></li>
                        </div>
                        <div class="cardmenu">
                            <i class="bi bi-house-door"></i>
                            <li><a href="ambientes.html">Ambientes</a></li>
                        </div>
                    </div>
                    <div class="sair" onclick="Sair()">
                        <i class="bi bi-box-arrow-right"></i>
                        <p>Sair</p>
                    </div>

                </ul>
            </nav>
        </div>
        <div class="logo">
            <img src="../assets/logo_senai.png" alt="logo-senai">
        </div>
        <div class="notificacao">
            <i class="bi bi-bell"></i>
        </div>
    </header>
    <main>
        <div class="escrita">
            <i class="bi bi-arrow-left" onclick="Voltar()"></i>
            <h1>Escannear Patrimônio</h1>
        </div>

        <form class="d-flex" role="search">
            <input class="form-control me-2" type="search" placeholder="Inserir código" aria-label="Search"
                id="barra" />
            <button class="btn btn-outline" type="submit" style="background-color: #940808; color:#fff;"><i
                    class="bi bi-check-square-fill"></i></button>
        </form>

        <!-- ESCANNER -->
        <div class="escanner">
            <div id="scanner"></div>
            <div id="lista-codes"></div>
            <button onclick="iniciarScanner()" class="buttonscanner">Iniciar Scanner</button>
        </div>


    </main>

    <!-- Modal de Sucesso -->
    <div id="modal-sucesso" class="modal-overlay">
        <div class="modal-content">
            <i class="bi bi-check-circle-fill" style="color: rgb(30, 175, 5); font-size: 80px;"></i>
            <h2>Item escaneado com sucesso!</h2>
            <p id="codigo-modal"></p>
        </div>
    </div>


    <!-- Biblioteca HTML5 QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script>
        let scanner;
        let codigosLidos = new Set();
        let scannerAtivo = false; // controla se está rodando

        function iniciarScanner() {
            if (scannerAtivo && scanner) {
                scanner.stop().then(() => {
                    console.log("Scanner parado para reinício.");
                    scannerAtivo = false;
                    startScan();
                }).catch(err => {
                    console.warn("Não foi possível parar o scanner:", err);
                    startScan();
                });
            } else {
                startScan();
            }
        }

        function startScan() {
            scanner = new Html5Qrcode("scanner");

            scanner.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 330, height: 270 },
                    formatsToSupport: [
                        Html5QrcodeSupportedFormats.QR_CODE,
                        Html5QrcodeSupportedFormats.CODE_128,
                        Html5QrcodeSupportedFormats.CODE_39,
                        Html5QrcodeSupportedFormats.EAN_13,
                        Html5QrcodeSupportedFormats.EAN_8,
                        Html5QrcodeSupportedFormats.UPC_A,
                        Html5QrcodeSupportedFormats.UPC_E
                    ]
                },
                codigo => {
                    if (!codigosLidos.has(codigo)) {
                        codigosLidos.add(codigo);

                        // alert("Código capturado: " + codigo);

                        const lista = document.getElementById("lista-codes");
                        const item = document.createElement("div");
                        item.textContent = codigo;
                        lista.appendChild(item);

                        // Mostra modal de sucesso
                        mostrarModal(codigo);

                        // Para o scanner só se estiver ativo
                        if (scannerAtivo) {
                            scanner.stop().then(() => {
                                scannerAtivo = false;
                                console.log("Scanner parado após captura.");
                            });
                        }
                    }
                },
                errorMessage => {
                    console.log("Erro de leitura: " + errorMessage);
                }
            ).then(() => {
                scannerAtivo = true;
                console.log("Scanner iniciado.");
            }).catch(err => {
                console.error("Não foi possível iniciar o scanner: " + err);
            });
        }

        function mostrarModal(codigo) {
            const modal = document.getElementById("modal-sucesso");
            const codigoModal = document.getElementById("codigo-modal");
            codigoModal.textContent = codigo;

            modal.style.display = "flex"; // mostra o modal

            // // Fecha o modal após 2 segundos
            setTimeout(() => {
                modal.style.display = "none";
                window.location.href = "fotografia.html"; // redireciona
            }, 2000);
        }

        function Voltar(){
            window.location.href = 'ambientes.html'
        }
         // MENU
        const hamburguer = document.querySelector(".hamburguer");
        const nav = document.querySelector("nav");

        hamburguer.addEventListener("click", () => {
            // animação do hambúrguer (vira X)
            hamburguer.classList.toggle("aberto");

            // abre/fecha o menu
            nav.classList.toggle("ativo");
        });

    </script>
</body>

</html>